<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Chatbot Input Suara & Teks</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background: #f4f4f4;
    }
    #output {
      white-space: pre-wrap;
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      min-height: 150px;
      margin-bottom: 1rem;
    }
    textarea {
      width: 100%;
      height: 60px;
      padding: 0.5rem;
      font-size: 1rem;
      margin-bottom: 1rem;
    }
    button {
      padding: 0.5rem 1rem;
      margin-right: 0.5rem;
      font-size: 1rem;
      border-radius: 5px;
      border: none;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    #status {
      margin-bottom: 10px;
      font-style: italic;
      color: gray;
    }

    .listening {
      animation: zoom 1s infinite;
      background-color: red !important;
    }

    @keyframes zoom {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <h2>ðŸ§  Chatbot - Input Suara & Teks</h2>
  <div id="output">Jawaban chatbot akan tampil di sini...</div>

  <div id="status">Status: idle</div>
  <textarea id="userInput" placeholder="Ketik pertanyaan..."></textarea><br>
  <button id="voiceButton" onclick="toggleRecognition()">ðŸŽ¤ Gunakan Suara</button>
  <button onclick="sendUserInput()">ðŸš€ Kirim</button>

  <script>
    const output = document.getElementById('output');
    const status = document.getElementById('status');
    const userInput = document.getElementById('userInput');

    const voiceQueue = [];
    let isSpeaking = false;
    let sentenceBuffer = '';
    let recognitionInstance = null;
    let isListening = false;

    function abortSpeech() {
      speechSynthesis.cancel();
      voiceQueue.length = 0;
      isSpeaking = false;
    }

    function stripMarkdown(text) {
      return text
        .replace(/[#_*~`>]+/g, '')
        .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
        .replace(/!\[.*?\]\(.*?\)/g, '')
        .replace(/```[\s\S]*?```/g, '')
        .replace(/`[^`]*`/g, '')
        .replace(/^[-*+] /gm, '')
        .replace(/^\d+\.\s+/gm, '')
        .replace(/\n{2,}/g, '\n')
        .trim();
    }

    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'id-ID';
      utterance.rate = 1.0;
      utterance.onend = () => {
        isSpeaking = false;
        if (voiceQueue.length > 0) {
          speak(voiceQueue.shift());
        }
      };
      speechSynthesis.speak(utterance);
      isSpeaking = true;
    }

    function enqueueIfSentenceComplete(text) {
      const plainText = stripMarkdown(text);
      sentenceBuffer += plainText;
      const matches = sentenceBuffer.match(/(.+?[.?!])(\s|$)/g);
      if (matches) {
        matches.forEach((sentence) => {
          if (!isSpeaking && voiceQueue.length === 0) {
            speak(sentence.trim());
          } else {
            voiceQueue.push(sentence.trim());
          }
        });
        sentenceBuffer = sentenceBuffer.replace(/(.+?[.?!])(\s|$)/g, '');
      }
    }

    async function sendUserInput() {
      abortSpeech();
      const content = userInput.value.trim();
      if (!content) return;
      userInput.value = '';
      output.textContent = 'â³ Menunggu jawaban...';
      await callChatbot(content);
    }

    async function callChatbot(userMessage) {
      sentenceBuffer = '';
      const response = await fetch('https://myllm.nusantaracode.com/api/v0/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: "meta-llama-3.1-8b-instruct",
          messages: [
            { role: "system", content: "Always answer in rhymes." },
            { role: "user", content: userMessage }
          ],
          temperature: 0,
          max_tokens: -1,
          stream: true
        })
      });

      const reader = response.body.getReader();
      const decoder = new TextDecoder('utf-8');
      let partial = '';
      output.textContent = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value, { stream: true });
        partial += chunk;
        const lines = partial.split('\n');
        partial = lines.pop();
        for (const line of lines) {
          if (!line.startsWith('data:')) continue;
          const jsonStr = line.slice(5).trim();
          if (jsonStr === '[DONE]') {
            if (sentenceBuffer.trim()) enqueueIfSentenceComplete('.');
            return;
          }
          try {
            const data = JSON.parse(jsonStr);
            const content = data?.choices?.[0]?.delta?.content;
            if (content) {
              output.textContent += content;
              enqueueIfSentenceComplete(content);
            }
          } catch (e) {
            console.warn('Parsing error:', e);
          }
        }
      }
    }

    function toggleRecognition() {
      if (isListening) {
        stopRecognition();
      } else {
        startRecognition();
      }
    }
    
function startRecognition() {
  abortSpeech();
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("Speech Recognition tidak didukung browser ini.");
    return;
  }

  recognitionInstance = new SpeechRecognition();
  recognitionInstance.lang = 'id-ID';
  recognitionInstance.interimResults = true; // âœ… Aktifkan hasil sementara
  recognitionInstance.maxAlternatives = 1;

  recognitionInstance.onstart = () => {
    isListening = true;
    status.textContent = "Status: Mendengarkan...";
    updateVoiceButton(true);
  };

  recognitionInstance.onresult = (event) => {
    let interimTranscript = '';
    let finalTranscript = '';

    for (let i = event.resultIndex; i < event.results.length; i++) {
      const transcript = event.results[i][0].transcript;
      if (event.results[i].isFinal) {
        finalTranscript += transcript;
      } else {
        interimTranscript += transcript;
      }
    }

    // Tampilkan transkrip di textarea saat bicara
    userInput.value = finalTranscript + interimTranscript;

    // Jika final selesai, otomatis kirim
    if (finalTranscript.trim() !== '') {
      status.textContent = "Status: Selesai mendengar.";
      stopRecognition();
      sendUserInput();
    }
  };

  recognitionInstance.onerror = (event) => {
    status.textContent = `Status: Error - ${event.error}`;
    stopRecognition();
  };

  recognitionInstance.onend = () => {
    if (isListening) {
      status.textContent = "Status: Tidak ada suara terdeteksi.";
      stopRecognition();
    }
  };

  recognitionInstance.start();
}


    function stopRecognition() {
      if (recognitionInstance) {
        recognitionInstance.stop();
        recognitionInstance = null;
      }
      isListening = false;
      updateVoiceButton(false);
      status.textContent = "Status: idle";
    }

    function updateVoiceButton(active) {
      const btn = document.getElementById('voiceButton');
      if (active) {
        btn.textContent = 'ðŸ›‘ Berhenti Mendengarkan';
        btn.classList.add('listening');
      } else {
        btn.textContent = 'ðŸŽ¤ Gunakan Suara';
        btn.classList.remove('listening');
      }
    }
  </script>
</body>
</html>
